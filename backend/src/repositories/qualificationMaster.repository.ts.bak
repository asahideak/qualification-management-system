import prisma from '../lib/database';
import logger, { PerformanceTracker } from '../lib/logger';
import { QualificationMaster } from '../types';

export interface QualificationMasterRepository {
  findAll(): Promise<QualificationMaster[]>;
  findById(id: string): Promise<QualificationMaster | null>;
  findByCategory(category: string): Promise<QualificationMaster[]>;
}

export class PrismaQualificationMasterRepository implements QualificationMasterRepository {
  async findAll(): Promise<QualificationMaster[]> {
    const tracker = new PerformanceTracker('QualificationMaster.findAll');
    try {
      logger.debug('資格マスター一覧取得開始');

      const qualificationMasters = await prisma.qualification_masters.findMany({
        where: {
          isActive: true,
        },
        orderBy: [
          { category: 'asc' },
          { name: 'asc' },
        ],
      });

      logger.info('資格マスター一覧取得成功', {
        count: qualificationMasters.length,
      });

      // Prismaモデルから型定義に変換
      const result: QualificationMaster[] = qualificationMasters.map(master => ({
        qualificationMasterId: master.id,
        masterName: master.name,
        validityPeriod: master.validityPeriod === 'permanent'
          ? 'permanent'
          : parseInt(master.validityPeriod, 10),
        category: master.category || undefined,
        isActive: master.isActive,
        createdAt: master.createdAt.toISOString(),
        updatedAt: master.updatedAt.toISOString(),
      }));

      tracker.end({ recordCount: result.length });
      return result;
    } catch (error) {
      logger.error('資格マスター一覧取得エラー', {
        error: error instanceof Error ? error.message : String(error),
      });
      tracker.end({ error: true });
      throw new Error('資格マスター一覧の取得に失敗しました');
    }
  }

  async findById(id: string): Promise<QualificationMaster | null> {
    const tracker = new PerformanceTracker('QualificationMaster.findById');
    try {
      logger.debug('資格マスター詳細取得開始', { qualificationMasterId: id });

      const master = await prisma.qualification_masters.findUnique({
        where: {
          id,
          isActive: true,
        },
      });

      if (!master) {
        logger.warn('資格マスターが見つかりません', { qualificationMasterId: id });
        tracker.end({ found: false });
        return null;
      }

      logger.info('資格マスター詳細取得成功', { qualificationMasterId: id });

      const result: QualificationMaster = {
        qualificationMasterId: master.id,
        masterName: master.name,
        validityPeriod: master.validityPeriod === 'permanent'
          ? 'permanent'
          : parseInt(master.validityPeriod, 10),
        category: master.category || undefined,
        isActive: master.isActive,
        createdAt: master.createdAt.toISOString(),
        updatedAt: master.updatedAt.toISOString(),
      };

      tracker.end({ found: true });
      return result;
    } catch (error) {
      logger.error('資格マスター詳細取得エラー', {
        qualificationMasterId: id,
        error: error instanceof Error ? error.message : String(error),
      });
      tracker.end({ error: true });
      throw new Error('資格マスター詳細の取得に失敗しました');
    }
  }

  async findByCategory(category: string): Promise<QualificationMaster[]> {
    const tracker = new PerformanceTracker('QualificationMaster.findByCategory');
    try {
      logger.debug('カテゴリ別資格マスター取得開始', { category });

      const qualificationMasters = await prisma.qualification_masters.findMany({
        where: {
          category,
          isActive: true,
        },
        orderBy: {
          name: 'asc',
        },
      });

      logger.info('カテゴリ別資格マスター取得成功', {
        category,
        count: qualificationMasters.length,
      });

      const result: QualificationMaster[] = qualificationMasters.map(master => ({
        qualificationMasterId: master.id,
        masterName: master.name,
        validityPeriod: master.validityPeriod === 'permanent'
          ? 'permanent'
          : parseInt(master.validityPeriod, 10),
        category: master.category || undefined,
        isActive: master.isActive,
        createdAt: master.createdAt.toISOString(),
        updatedAt: master.updatedAt.toISOString(),
      }));

      tracker.end({ recordCount: result.length, category });
      return result;
    } catch (error) {
      logger.error('カテゴリ別資格マスター取得エラー', {
        category,
        error: error instanceof Error ? error.message : String(error),
      });
      tracker.end({ error: true });
      throw new Error('カテゴリ別資格マスターの取得に失敗しました');
    }
  }
}